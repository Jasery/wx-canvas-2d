!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.WxCanvas2d=e():t.WxCanvas2d=e()}(window,(function(){return function(t){var e={};function i(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(r,s,function(e){return t[e]}.bind(null,s));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";function r(t){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}i.r(e);var s=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],o=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function n(t,e,i,s,o){if("string"==typeof t&&(t=document.getElementById(t)),!t||"object"!==r(t)||!("getContext"in t))throw new TypeError("Expecting canvas with `getContext` method in processCanvasRGB(A) calls!");var n=t.getContext("2d");try{return n.getImageData(e,i,s,o)}catch(t){throw new Error("unable to access image data: "+t)}}function h(t,e,i,r,h,a){if(!(isNaN(a)||a<1)){a|=0;var l=n(t,e,i,r,h);l=function(t,e,i,r,n,h){for(var a,l=t.data,d=2*h+1,u=r-1,x=n-1,g=h+1,p=g*(g+1)/2,f=new c,w=f,b=1;b<d;b++)w=w.next=new c,b===g&&(a=w);w.next=f;for(var m,y,v=null,D=null,S=s[h],C=o[h],P=0,W=0,L=0;L<n;L++){var T=l[W],I=l[W+1],F=l[W+2],M=g*T,$=g*I,B=g*F,O=p*T,j=p*I,E=p*F;w=f;for(var z=0;z<g;z++)w.r=T,w.g=I,w.b=F,w=w.next;for(var A=0,R=0,q=0,k=1;k<g;k++)m=W+((u<k?u:k)<<2),O+=(w.r=T=l[m])*(y=g-k),j+=(w.g=I=l[m+1])*y,E+=(w.b=F=l[m+2])*y,A+=T,R+=I,q+=F,w=w.next;v=f,D=a;for(var H=0;H<r;H++)l[W]=O*S>>C,l[W+1]=j*S>>C,l[W+2]=E*S>>C,O-=M,j-=$,E-=B,M-=v.r,$-=v.g,B-=v.b,m=P+((m=H+h+1)<u?m:u)<<2,A+=v.r=l[m],R+=v.g=l[m+1],q+=v.b=l[m+2],O+=A,j+=R,E+=q,v=v.next,M+=T=D.r,$+=I=D.g,B+=F=D.b,A-=T,R-=I,q-=F,D=D.next,W+=4;P+=r}for(var _=0;_<r;_++){var Q=l[W=_<<2],J=l[W+1],N=l[W+2],G=g*Q,K=g*J,U=g*N,V=p*Q,X=p*J,Y=p*N;w=f;for(var Z=0;Z<g;Z++)w.r=Q,w.g=J,w.b=N,w=w.next;for(var tt=0,et=0,it=0,rt=1,st=r;rt<=h;rt++)W=st+_<<2,V+=(w.r=Q=l[W])*(y=g-rt),X+=(w.g=J=l[W+1])*y,Y+=(w.b=N=l[W+2])*y,tt+=Q,et+=J,it+=N,w=w.next,rt<x&&(st+=r);W=_,v=f,D=a;for(var ot=0;ot<n;ot++)l[m=W<<2]=V*S>>C,l[m+1]=X*S>>C,l[m+2]=Y*S>>C,V-=G,X-=K,Y-=U,G-=v.r,K-=v.g,U-=v.b,m=_+((m=ot+g)<x?m:x)*r<<2,V+=tt+=v.r=l[m],X+=et+=v.g=l[m+1],Y+=it+=v.b=l[m+2],v=v.next,G+=Q=D.r,K+=J=D.g,U+=N=D.b,tt-=Q,et-=J,it-=N,D=D.next,W+=r}return t}(l,0,0,r,h,a),t.getContext("2d").putImageData(l,e,i)}}var c=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.r=0,this.g=0,this.b=0,this.a=0,this.next=null};const a=wx.getSystemInfoSync();class l{constructor(){this.query=null,this.bgColor=null,this.radius=null,this.component=null,this.canvas=null,this.ctx=null,this.dpr=null,this.rootWidth=null,this.fontFamily="sans-serif",this.startTime=Date.now(),this.debugger=!1}create(t){return new Promise((e,i)=>{const r={query:"",rootWidth:375,...t};r.query||i(new Error("[WxCanvas2d] 'query' is empty.")),this.query=r.query,this.bgColor=r.bgColor,this.component=r.component,this.radius=r.radius;(this.component?wx.createSelectorQuery().in(this.component):wx.createSelectorQuery()).select(this.query).fields({node:!0,size:!0}).exec(t=>{if(!t[0])return this.debugLogout(d[108]+" (108)","error"),!1;const i=t[0].node,s=i.getContext("2d"),o=a.pixelRatio;this.canvas=i,this.ctx=s,this.dpr=o,this.rootWidth=r.rootWidth,this.canvas.width=t[0].width*this.dpr,this.canvas.height=t[0].height*this.dpr,e()})})}clear(){this.ctx.clearRect(0,0,this.xDpr(this.canvas.width),this.xDpr(this.canvas.height)),this.radius&&(this.drawRectPath({x:0,y:0,width:this.canvas.width/a.screenWidth/this.dpr*this.rootWidth,height:this.canvas.height/a.screenWidth/this.dpr*this.rootWidth,radius:this.radius}),this.ctx.clip()),this.bgColor&&(this.ctx.fillStyle=this.bgColor,this.ctx.fillRect(0,0,this.xDpr(this.canvas.width),this.xDpr(this.canvas.height)))}xDpr(t){return t*this.dpr*a.screenWidth/this.rootWidth}draw(t){return new Promise((e,i)=>{this.startTime=Date.now();const{series:r}=t;(this.component?wx.createSelectorQuery().in(this.component):wx.createSelectorQuery()).select(this.query).fields({node:!0,size:!0}).exec(t=>{if(!t[0])return!1;this.canvas.width=t[0].width*this.dpr,this.canvas.height=t[0].height*this.dpr,this.clear();const s=r.map(t=>({...t,zIndex:t.zIndex||0})).sort((t,e)=>t.zIndex-e.zIndex),o={rect:(t,...e)=>this.drawRect(...e),image:(t,...e)=>this.drawImage(...e),text:(t,...e)=>this.drawText(...e),line:(t,...e)=>this.drawLine(...e),blur:(t,...e)=>this.drawBlur(...e),arc:(t,...e)=>this.drawArc(...e),...l.extendDrawMethods},n=(t=0)=>{if(t<s.length){const e=s[t];o[e.type]?(this.styleClear(),o[e.type](this,e).then(()=>{this.debugLogout(`绘制成功 [${e.type}] (${t+1}/${s.length})`),n(++t)}).catch(t=>{this.debugLogout("绘制失败"),i(t)})):(this.debugLogout(`未知类型 type: '${e.type}'`,"error"),n(++t))}else this.debugLogout(`绘制完成 (${Date.now()-this.startTime}ms)`),e()};this.debugLogout("开始绘制"),n()})})}styleClear(){this.ctx.setTextAlign="left",this.ctx.textBaseline="top",this.ctx.fillStyle="#000",this.ctx.font=`${this.xDpr(12*this.rootWidth/a.screenWidth)}px ${this.fontFamily}`,this.ctx.lineCap="butt",this.ctx.setLineDash([1,0]),this.ctx.lineDashOffset=0,this.ctx.lineJoin="bevel",this.ctx.lineWidth=this.xDpr(1),this.ctx.strokeStyle="#000"}setLineStyle(t={}){const{cap:e="butt",join:i="bevel",offset:r=0,dash:s=[1,0],color:o="#000",width:n=2}=t;this.ctx.lineCap=e,this.ctx.setLineDash(s.map(t=>this.xDpr(t))),this.ctx.lineDashOffset=this.xDpr(r),this.ctx.lineJoin=i,this.ctx.lineWidth=this.xDpr(n),this.ctx.strokeStyle=o}drawRect(t){return new Promise((e,i)=>{let{x:r=0,y:s=0,width:o=0,height:n=0,bgColor:h="",radius:c=0,lineStyle:a}=t;c=Math.min(c,Math.min(o,n)/2),this.setLineStyle(a),this.ctx.fillStyle=h,this.drawRectPath({x:r,y:s,width:o,height:n,radius:c}),a.color&&this.ctx.stroke(),h&&this.ctx.fill(),e()})}drawRectPath(t){const{x:e=0,y:i=0,width:r=0,height:s=0,radius:o=0}=t,n={top:1.5*Math.PI,right:0,bottom:.5*Math.PI,left:Math.PI},h=[[n.left,n.top],[n.top,n.right],[n.right,n.bottom],[n.bottom,n.left]],c=[[e+o,i+o].map(t=>this.xDpr(t)),[e+r-o,i+o].map(t=>this.xDpr(t)),[e+r-o,i+s-o].map(t=>this.xDpr(t)),[e+o,i+s-o].map(t=>this.xDpr(t))];this.ctx.beginPath(),Array(4).fill().forEach((t,e)=>{this.ctx.arc(...c[e],this.xDpr(o),...h[e])}),this.ctx.closePath()}drawImage(t){const{url:e="",x:i=0,y:r=0,width:s=0,height:o=0,mode:n="scaleToFill",radius:h=0}=t;return new Promise((t,c)=>{const a=this.canvas.createImage();a.src=e,a.onload=()=>{wx.getImageInfo({src:e,success:e=>{const c=e.width,l=e.height,d=s/o;let u=1,x=1;"aspectFit"===n?(u=e.width/e.height<d?s/e.width*e.height/o:1,x=e.width/e.height>d?o/e.height*e.width/s:1):"aspectFill"===n&&(u=e.width/e.height>d?s/e.width*e.height/o:1,x=e.width/e.height<d?o/e.height*e.width/s:1);const g={scaleToFill:[0,0,c,l],aspectFit:[(e.width-e.width*u)/2,(e.height-e.height*x)/2,e.width*u,e.height*x],aspectFill:[(e.width-e.width*u)/2,(e.height-e.height*x)/2,e.width*u,e.height*x],widthFix:[],top:[(c-s)/2,0,s,o],bottom:[(c-s)/2,l-o,s,o],center:[(c-s)/2,(l-o)/2,s,o],left:[0,(l-o)/2,s,o],right:[c-s,(l-o)/2,s,o],"top left":[0,0,s,o],"top right":[c-s,0,s,o],"bottom left":[0,l-o,s,o],"bottom right":[c-s,l-o,s,o]};h&&(this.ctx.save(),this.drawRectPath({x:i,y:r,width:s,height:o,radius:h}),this.ctx.clip()),this.ctx.drawImage(a,...g[n]||[],this.xDpr(i)||0,this.xDpr(r)||0,this.xDpr(s||e.width),this.xDpr(o||e.height)),h&&this.ctx.restore(),t()},fail:()=>{c(u(106))}})},a.onerror=()=>{c(u(107))}})}drawText(t){return new Promise((e,i)=>{const r={x:0,y:0,color:"#000",fontSize:12,fontWeight:"",width:1/0,baseline:"top",align:"left",...t,text:String(t.text)||"",ellipsis:Math.max(+t.ellipsis,0),lineHeight:t.lineHeight||t.fontSize||12};let s=0,o=0,n=[];this.ctx.setTextAlign=r.align,this.ctx.textBaseline=r.baseline,this.ctx.fillStyle=r.color,this.ctx.font=`${r.fontWeight} ${this.xDpr(r.fontSize)}px ${this.fontFamily}`,r.text.split("").forEach((t,e)=>{const i=r.text.slice(s,e+1);this.ctx.measureText(i).width<this.xDpr(r.width)?n[o]=i:(s=e,o++)}),r.ellipsis&&n.length>r.ellipsis&&(n=n.slice(0,r.ellipsis),n[r.ellipsis-1]=n[r.ellipsis-1].slice(0,-1)+"..."),n.forEach((t,e)=>{const i=r.y+r.lineHeight*e+(r.lineHeight-r.fontSize)/2;this.ctx.fillText(t,this.xDpr(r.x),this.xDpr(i))}),e()})}drawLine(t){return new Promise((e,i)=>{const{lineStyle:r,line:s=[]}=t;this.setLineStyle(r),s.forEach((t,e)=>{e?(this.ctx.lineTo(...t.point.map(t=>this.xDpr(t))),this.ctx.stroke()):(this.ctx.beginPath(),this.ctx.moveTo(...t.point.map(t=>this.xDpr(t))))}),e()})}drawBlur(t){return new Promise((e,i)=>{const{x:r=0,y:s=0,width:o=0,height:n=0,blur:c=0}=t;h(this.canvas,this.xDpr(r),this.xDpr(s),this.xDpr(o),this.xDpr(n),c),e()})}drawArc(t){return new Promise((e,i)=>{const{x:r=0,y:s=0,r:o=0,start:n=0,end:h=0,reverse:c=!1,lineStyle:a}=t;this.setLineStyle(a),this.ctx.beginPath(),this.ctx.arc(this.xDpr(r),this.xDpr(s),this.xDpr(o),n,h,c),this.ctx.stroke(),e()})}saveToAlbum(t){return new Promise((e,i)=>{const r={x:0,y:0,width:0,height:0,destWidth:0,destHeight:0,modalOption:{},...t};wx.canvasToTempFilePath({x:r.x,y:r.y,width:r.width,height:r.height,destWidth:this.xDpr(r.destWidth),destHeight:this.xDpr(r.destHeight),canvas:this.canvas,success:t=>{const s=t.tempFilePath;x("writePhotosAlbum").then(t=>{1===t.code?wx.showModal({title:r.modalOption.title||"获取权限",content:r.modalOption.content||"请前往开启相册权限",success:r.modalOption.success||(t=>{t.confirm?(wx.openSetting(),this.debugLogout(d[105]+" (105)","error"),i(u(105))):t.cancel&&(this.debugLogout(d[104]+" (104)","error"),i(u(104)))})}):[2,3].includes(t.code)&&g(s).then(t=>{this.debugLogout("保存图片到相册成功"),e()}).catch(()=>{this.debugLogout(d[102]+" (102)","error"),i(u(102))})}).catch(()=>{this.debugLogout(d[101]+" (101)","error"),i(u(101))})},fail:()=>{this.debugLogout(d[100]+" (100)","error"),i(u(100))}})})}debugLogout(...t){this.debugger&&p(...t)}}l.extendDrawMethods={},l.addSeries=function(t,e){l.extendDrawMethods[t]=e};const d={100:"生成图片失败",101:"获取设置信息失败",102:"保存图片到相册失败",103:"授权失败",104:"用户拒绝授权",105:"用户前往授权页",106:"获取图片信息失败",107:"加载图片失败",108:"找不到画布"},u=function(t){return{code:t,msg:d[t]}},x=function(t){return new Promise((e,i)=>{wx.getSetting({success(i){const r=t=>({settings:i,code:t});void 0!==i.authSetting["scope."+t]&&!0!==i.authSetting["scope."+t]?e(r(1)):void 0===i.authSetting["scope."+t]?e(r(2)):e(r(3))},fail(t){i(t)}})})},g=function(t){return new Promise((e,i)=>{wx.saveImageToPhotosAlbum({filePath:t,success:t=>{e()},fail:t=>{i(t)}})})},p=function(t,e="info"){if(!t)return;const i=function(e,i){console.log("%cWxCanvas2d%c"+t,`\n            color: ${e.color};\n            background-color: ${e.bgColor};\n            padding: 1px 4px;\n            border-radius: 4px 0 0 4px;\n        `,`\n            color: ${i.color};\n            background-color: ${i.bgColor};\n            padding: 1px 4px;\n            border-radius: 0 4px 4px 0;\n        `)};"devtools"===a.brand?"info"===e?i({color:"#004B1C",bgColor:"#2BDC70"},{color:"#084BBC",bgColor:"#81A9F0"}):"error"===e?i({color:"#006727",bgColor:"#2BDC70"},{color:"#D82E2E",bgColor:"#FFB2B2"}):console.log("WxCanvas2d: "+t):console.debug("WxCanvas2d: "+t)};e.default=l}])}));
//# sourceMappingURL=wx-canvas-2d.min.js.map